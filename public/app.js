// Generated by CoffeeScript 1.10.0
(function() {
  angular.module('west', ['ui.bootstrap', 'west-router', 'west-dbms']).directive('ckEditor', function() {
    return {
      require: '?ngModel',
      link: function(scope, elm, attr, ngModel) {
        var ck;
        ck = CKEDITOR.replace(elm[0]);
        if (!ngModel) {
          return;
        }
        ck.on('pasteState', function() {
          return scope.$apply(function() {
            return ngModel.$setViewValue(ck.getData());
          });
        });
        return ngModel.$render = function(value) {
          return ck.setData(ngModel.$viewValue);
        };
      }
    };
  }).filter('richtext', [
    '$sce', function($sce) {
      return function(html) {
        return $sce.trustAsHtml(html);
      };
    }
  ]).controller('main', function($scope, $timeout, DBMS, $location, $route) {
    var update;
    $scope.router = $route;
    $scope.now = new Date();
    update = function() {
      $scope.now = new Date();
      return $timeout(update, 1000);
    };
    update();
    $scope.slides = DBMS.slides;
    DBMS.news.refresh();
    DBMS.richtext.refresh();
    DBMS.policies.refresh();
    $scope.news_list = DBMS.news.data;
    $scope.news_dic = DBMS.news.dic;
    $scope.about = DBMS.richtext.about;
    $scope.notify = DBMS.richtext.notify;
    $scope.contact = DBMS.richtext.contact;
    $scope.expert = DBMS.richtext.expert;
    $scope.policy_list = DBMS.policies.data;
    $scope.policy_dic = DBMS.policies.dic;
    DBMS.user.refresh();
    return $scope.user = DBMS.user;
  }).controller('login', function($scope, $http, $location, DBMS) {
    $scope.form = {
      username: "",
      password: ""
    };
    return $scope.login = function() {
      return $http.post("/users/login", $scope.form).then(function(res) {
        console.log(res.data);
        DBMS.user.refresh();
        alert("Login successfully.");
        return $location.path('/').replace();
      })["catch"](function(res) {
        var err;
        err = res.data;
        return alert(err.message);
      });
    };
  }).controller('news', function($scope, $location, $route, DBMS) {
    var news_id;
    $scope.form = {
      title: "",
      content: ""
    };
    $scope.submit = function() {
      return DBMS.news.push($scope.form).then(function(news) {
        $scope.form.title = "";
        $scope.form.content = "";
        return $location.path("/news/" + news.id).replace();
      })["catch"](function(err) {
        alert(err.data.message);
        return console.log(err);
      });
    };
    $scope["delete"] = function(news) {
      var c;
      c = confirm("确定要删除这条新闻吗？");
      if (!c) {
        return;
      }
      return DBMS.news["delete"](news).then(function() {
        return $location.path('/news').replace();
      })["catch"](function(err) {
        alert(err.data.message);
        return console.log(err);
      });
    };
    news_id = $route.current.params.news_id;
    if (news_id) {
      $scope.form = {
        id: news_id,
        title: DBMS.news.dic[news_id].title,
        content: DBMS.news.dic[news_id].content
      };
    }
    return $scope.update = function() {
      return DBMS.news.update({
        id: $route.current.params.news_id,
        title: DBMS.news.dic[news_id].title,
        content: DBMS.news.dic[news_id].content
      }).then(function(news) {
        $scope.form.title = "";
        $scope.form.content = "";
        return $location.path("/news/" + news.id).replace();
      })["catch"](function(err) {
        alert(err.data.message);
        return console.log(err);
      });
    };
  }).controller('policy', function($scope, $location, $route, DBMS) {
    var policy_id;
    $scope.form = {
      title: "",
      content: ""
    };
    $scope.submit = function() {
      return DBMS.policies.push($scope.form).then(function(policy) {
        $scope.form.title = "";
        $scope.form.content = "";
        return $location.path("/polices/" + policy.id).replace();
      })["catch"](function(err) {
        alert(err.data.message);
        return console.log(err);
      });
    };
    policy_id = $route.current.params.policy_id;
    if (policy_id) {
      $scope.form = {
        id: policy_id,
        title: DBMS.policies.dic[policy_id].title,
        content: DBMS.policies.dic[policy_id].content
      };
    }
    $scope.update = function() {
      return DBMS.policies.update($scope.form).then(function(policy) {
        $scope.form.title = "";
        $scope.form.content = "";
        return $location.path("/polices/" + policy.id).replace();
      })["catch"](function(err) {
        alert(err.data.message);
        return console.log(err);
      });
    };
    return $scope["delete"] = function(policy) {
      var c;
      c = confirm("确定要删除这条政策吗？");
      if (!c) {
        return;
      }
      return DBMS.policies["delete"](policy).then(function() {
        return $location.path('/policy').replace();
      })["catch"](function(err) {
        alert(err.data.message);
        return console.log(err);
      });
    };
  }).controller('edit-richtext', function($scope, $location, DBMS, $route) {
    $scope.richtext = {};
    $scope.richtext.name = $route.current.params.key;
    $scope.richtext.content = DBMS.richtext[$scope.richtext.name].content;
    return $scope.update = function() {
      console.log($scope.richtext);
      return DBMS.richtext.update($scope.richtext).then(function() {
        alert("Updated successfully.");
        return $location.path("/index").replace();
      })["catch"](function(err) {
        alert(err.data.message);
        return console.log(err);
      });
    };
  });

}).call(this);

//# sourceMappingURL=app.js.map
